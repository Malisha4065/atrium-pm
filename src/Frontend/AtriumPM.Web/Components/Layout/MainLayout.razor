@inherits LayoutComponentBase
@inject AtriumPM.Web.Services.ApiSessionState Session
@inject NavigationManager NavigationManager

@if (!isInitialized)
{
    @* Show a loading state or nothing while checking auth to prevent flicker *@
}
else
{
    <div class="page">
        <div class="sidebar">
            <NavMenu />
        </div>

        <main>
            <div class="top-row px-4 d-flex justify-content-end align-items-center">
                <span class="text-muted d-flex align-items-center gap-2">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    <span>Tenant ID: @Session.TenantId</span>
                </span>
                <button class="btn btn-link text-muted ms-3 text-decoration-none" @onclick="Logout">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    Sign Out
                </button>
            </div>

            <article class="content px-4">
                @Body
            </article>
        </main>
    </div>
}

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">🗙</span>
</div>

@code {
    private bool isInitialized = false;

    protected override void OnInitialized()
    {
        if (!Session.IsAuthenticated)
        {
            NavigationManager.NavigateTo("/login");
        }
        else
        {
            isInitialized = true;
        }
    }

    private void Logout()
    {
        Session.Clear();
        NavigationManager.NavigateTo("/login", forceLoad: true);
    }
}
