@page "/"
@using AtriumPM.Web.Models
@using AtriumPM.Web.Services
@inject AtriumApiClient ApiClient

<PageTitle>Dashboard - AtriumPM</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1 text-white">Properties Overview</h2>
        <p class="text-muted mb-0">Manage your buildings and real estate assets.</p>
    </div>
    <div>
        <a href="/properties/new" class="btn btn-primary shadow-sm">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            Add Property
        </a>
    </div>
</div>

@if (!string.IsNullOrWhiteSpace(errorMessage))
{
    <div class="alert alert-danger mb-4 d-flex align-items-center gap-2 shadow-sm">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="flex-shrink-0" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
        <div>@errorMessage</div>
    </div>
}

@if (isLoading)
{
    <div class="d-flex justify-content-center align-items-center py-5">
        <span class="spinner-icon fs-4 text-primary">↻</span>
    </div>
}
else if (buildings.Count == 0)
{
    <div class="glass-card text-center p-5">
        <div class="mb-4 text-muted">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" class="mb-2" stroke="currentColor" stroke-width="1.5"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>
            <h5>No Properties Found</h5>
            <p>You haven't added any buildings to your portfolio yet.</p>
        </div>
        <a href="/properties/new" class="btn btn-outline-primary shadow-sm px-4 py-2">Create First Property</a>
    </div>
}
else
{
    <div class="row g-4">
        @foreach (var building in buildings)
        {
            <div class="col-12 col-md-6 col-lg-4">
                <a href="/properties/@building.Id" class="text-decoration-none">
                    <div class="glass-card h-100 property-card">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="p-2 rounded bg-primary bg-opacity-10 text-primary mb-2">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                            </div>
                        </div>
                        <h5 class="text-white mb-1 building-address">@building.Address</h5>
                        <p class="text-muted small font-monospace mb-4">ID: @building.Id.ToString().Substring(0, 8)...</p>
                        
                        <div class="d-flex align-items-center justify-content-between pt-3 border-top" style="border-color: var(--card-border) !important;">
                            <span class="text-primary fs-6 fw-semibold d-flex align-items-center gap-1">
                                View Details 
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                            </span>
                        </div>
                    </div>
                </a>
            </div>
        }
    </div>
}

<style>
    .property-card {
        transition: all 0.2s ease;
    }
    .property-card:hover {
        border-color: var(--primary);
        background: rgba(30, 41, 59, 0.85);
    }
    .building-address {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>

@code {
    private List<BuildingDto> buildings = new();
    private bool isLoading = true;
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadBuildingsAsync();
    }

    private async Task LoadBuildingsAsync()
    {
        try
        {
            isLoading = true;
            buildings = (await ApiClient.GetBuildingsAsync()).ToList();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load properties: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}
