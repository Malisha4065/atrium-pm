@page "/units"
@using AtriumPM.Web.Models
@using AtriumPM.Web.Services
@inject AtriumApiClient ApiClient

<PageTitle>Units - AtriumPM</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1 text-white">All Units</h2>
        <p class="text-muted mb-0">Manage all units across your properties.</p>
    </div>
</div>

<div class="glass-card mb-4 p-3 border-0">
    <div class="row g-3">
        <div class="col-12 col-md-5">
            <div class="form-floating">
                <select id="propertyFilter" class="form-select bg-dark text-white border-secondary" @bind="selectedBuildingId">
                    <option value="">All Properties (Buildings)</option>
                    @foreach (var p in properties)
                    {
                        <option value="@p.Id">@p.Address</option>
                    }
                </select>
                <label for="propertyFilter" class="text-muted">Filter by Property</label>
            </div>
        </div>
        <div class="col-12 col-md-7">
            <div class="form-floating">
                <input type="text" id="unitSearch" @bind="searchQuery" @bind:event="oninput" class="form-control bg-dark text-white border-secondary" placeholder="Search unit number" />
                <label for="unitSearch" class="text-muted">Search Unit Number / ID</label>
            </div>
        </div>
    </div>
</div>

@if (isLoading)
{
    <div class="d-flex justify-content-center py-5">
        <span class="spinner-icon fs-4 text-primary">â†»</span>
    </div>
}
else if (filteredUnits.Count == 0)
{
    <div class="glass-card text-center p-5">
        <div class="mb-3 text-muted">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" class="mb-2" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
            <h5>No matching units</h5>
            <p>Try adjusting your search criteria or property filter.</p>
        </div>
    </div>
}
else
{
    <div class="table-responsive glass-card px-0 py-0">
        <table class="table table-hover text-white mb-0">
            <thead style="background: rgba(0,0,0,0.2);">
                <tr>
                    <th class="border-0 px-4 py-3 text-secondary">Unit ID</th>
                    <th class="border-0 px-4 py-3 text-secondary">Unit No.</th>
                    <th class="border-0 px-4 py-3 text-secondary">Building</th>
                    <th class="border-0 px-4 py-3 text-secondary text-end">Action</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var unit in filteredUnits)
                {
                    <tr style="background: rgba(255,255,255,0.01);">
                        <td class="px-4 py-3 text-muted font-monospace align-middle">@unit.Id</td>
                        <td class="px-4 py-3 fw-semibold align-middle text-primary">Unit @unit.UnitNumber</td>
                        <td class="px-4 py-3 text-muted align-middle">
                            @(properties.FirstOrDefault(p => p.Id == unit.BuildingId)?.Address ?? "Unknown Property")
                        </td>
                        <td class="px-4 py-3 text-end align-middle">
                            <a href="/units/@unit.Id" class="btn btn-sm btn-outline-primary shadow-sm rounded-pill px-3">
                                View Details & Leases
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private List<UnitDto> units = new();
    private List<BuildingDto> properties = new();
    private bool isLoading = true;
    
    private string _searchQuery = string.Empty;
    private string searchQuery 
    { 
        get => _searchQuery; 
        set { _searchQuery = value; StateHasChanged(); } 
    }

    private string _selectedBuildingId = string.Empty;
    private string selectedBuildingId 
    { 
        get => _selectedBuildingId; 
        set { _selectedBuildingId = value; StateHasChanged(); } 
    }

    private List<UnitDto> filteredUnits
    {
        get 
        {
            var result = units.AsEnumerable();
            
            if (!string.IsNullOrWhiteSpace(selectedBuildingId) && Guid.TryParse(selectedBuildingId, out var bid))
            {
                result = result.Where(u => u.BuildingId == bid);
            }

            if (!string.IsNullOrWhiteSpace(searchQuery))
            {
                result = result.Where(u => u.UnitNumber.ToString() == searchQuery || u.Id.ToString().Contains(searchQuery, StringComparison.OrdinalIgnoreCase));
            }

            return result.OrderBy(u => u.UnitNumber).ToList();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            isLoading = true;
            properties = (await ApiClient.GetBuildingsAsync()).ToList();
            units = (await ApiClient.GetUnitsAsync()).ToList();
        }
        finally
        {
            isLoading = false;
        }
    }
}
