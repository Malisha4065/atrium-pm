@page "/leases"
@using AtriumPM.Web.Models
@using AtriumPM.Web.Services
@inject AtriumApiClient ApiClient

<PageTitle>Leases - AtriumPM</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1 text-white">All Leases</h2>
        <p class="text-muted mb-0">Overview of all resident contracts across properties.</p>
    </div>
</div>

<div class="glass-card mb-4 pe-3 py-2">
    <div class="d-flex align-items-center gap-3">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="text-muted ms-3" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        <input type="text" @bind="searchQuery" @bind:event="oninput" class="form-control bg-transparent border-0 text-white shadow-none ps-0" placeholder="Search leases by resident name or ID..." />
    </div>
</div>

@if (isLoading)
{
    <div class="d-flex justify-content-center py-5">
        <span class="spinner-icon fs-4 text-primary">â†»</span>
    </div>
}
else if (filteredLeases.Count == 0)
{
    <div class="glass-card text-center p-5">
        <div class="mb-3 text-muted">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" class="mb-2" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
            <h5>No leases found</h5>
            <p>You haven't signed any residents to units yet.</p>
        </div>
        <a href="/units" class="btn btn-outline-primary shadow-sm px-4 py-2">Go to Units to Create Leases</a>
    </div>
}
else
{
    <div class="table-responsive glass-card px-0 py-0">
        <table class="table table-hover text-white mb-0">
            <thead style="background: rgba(0,0,0,0.2);">
                <tr>
                    <th class="border-0 px-4 py-3 text-secondary">Lease ID</th>
                    <th class="border-0 px-4 py-3 text-secondary">Resident</th>
                    <th class="border-0 px-4 py-3 text-secondary">Unit ID</th>
                    <th class="border-0 px-4 py-3 text-secondary">Status</th>
                    <th class="border-0 px-4 py-3 text-secondary text-end">Action</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var lease in filteredLeases.OrderByDescending(l => l.StartDate))
                {
                    <tr style="background: rgba(255,255,255,0.01);">
                        <td class="px-4 py-3 text-muted font-monospace align-middle">@lease.Id</td>
                        <td class="px-4 py-3 fw-semibold align-middle">@lease.ResidentName</td>
                        <td class="px-4 py-3 text-muted font-monospace align-middle">
                            <a href="/units/@lease.UnitId" class="text-decoration-none text-primary">@lease.UnitId.ToString().Substring(0, 8)...</a>
                        </td>
                        <td class="px-4 py-3 align-middle">
                            <span class="badge @(lease.Status == "Active" ? "text-bg-success" : (lease.Status == "Pending" ? "text-bg-warning" : "text-bg-secondary"))">
                                @lease.Status
                            </span>
                        </td>
                        <td class="px-4 py-3 text-end align-middle">
                            <a href="/units/@lease.UnitId" class="btn btn-sm btn-outline-primary shadow-sm rounded-pill px-3">
                                View Unit
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private List<LeaseDto> leases = new();
    private bool isLoading = true;
    
    private string _searchQuery = string.Empty;
    private string searchQuery 
    { 
        get => _searchQuery; 
        set { _searchQuery = value; StateHasChanged(); } 
    }

    private List<LeaseDto> filteredLeases => string.IsNullOrWhiteSpace(searchQuery) 
        ? leases 
        : leases.Where(l => l.ResidentName.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) || l.Id.ToString().Contains(searchQuery, StringComparison.OrdinalIgnoreCase)).ToList();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            isLoading = true;
            leases = (await ApiClient.GetLeasesAsync()).ToList();
        }
        finally
        {
            isLoading = false;
        }
    }
}
